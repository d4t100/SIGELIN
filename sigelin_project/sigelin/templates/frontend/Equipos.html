<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Equipos - SIGELIN</title>
  <style>
    :root{--brand:#D32F2F;--bg:#f5f7fb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Roboto',Arial,sans-serif;background:var(--bg);color:#0b1220;display:flex;min-height:100vh}
    
    aside{width:220px;background:var(--brand);color:#fff;padding:20px;height:100vh;position:fixed;left:0;top:0;overflow-y:auto}
    aside h2{margin:0 0 20px;font-size:20px}
    aside a{display:block;color:#fff;text-decoration:none;margin:10px 0;padding:10px;border-radius:6px;transition:background 0.3s}
    aside a:hover{background:rgba(255,255,255,0.1)}
    aside a.active{background:rgba(255,255,255,0.2)}
    aside button{margin-top:20px;background:#fff;color:var(--brand);border:none;padding:10px;width:100%;border-radius:8px;cursor:pointer;font-weight:600}
    aside button:hover{background:#f5f5f5}
    
    main{flex:1;margin-left:220px;padding:20px;width:calc(100% - 220px)}
    
    .header{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .header h1{margin:0 0 8px;color:var(--brand)}
    
    .user-badge{background:rgba(255,255,255,0.1);padding:12px;border-radius:8px;margin-bottom:20px}
    .user-badge .name{font-weight:700;font-size:16px;margin-bottom:4px}
    .user-badge .role{font-size:13px;opacity:0.8}
    
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
    th{background:var(--brand);color:#fff;font-weight:600}
    tr:last-child td{border-bottom:none}
    
    .formulario{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .form-row{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    input,select{padding:10px;border-radius:6px;border:1px solid #ddd;flex:1;min-width:150px}
    .btn{background:var(--brand);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn:hover{background:#b71c1c}
    
    @media(max-width:768px){
      aside{width:100%;height:auto;position:relative}
      main{margin-left:0;width:100%}
    }
  </style>
  <script src="/static/frontend/auth.js"></script>
</head>
<body>
  <aside>
    <h2>SIGELIN</h2>
    
    <div class="user-badge">
      <div class="name" id="sidebarName">Usuario</div>
      <div class="role" id="sidebarRole">Rol</div>
    </div>
    
    <a href="/dashboard.html">üìä Panel</a>
    <a href="/equipos.html" class="active">üñ•Ô∏è Equipos</a>
    <a href="/reparaciones.html">üîß Reparaciones</a>
    <a href="/inventario.html">üì¶ Inventario</a>
    <a href="/reportes.html">üìÑ Reportes</a>
    
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </aside>

  <main>
    <div class="header">
      <h1>Gesti√≥n de Equipos</h1>
      <p>Administra el inventario de equipos del laboratorio</p>
    </div>

    <div class="formulario">
      <h3>Registrar Nuevo Equipo</h3>
      <div class="form-row">
        <input id="nombre" type="text" placeholder="Nombre del equipo" />
        <input id="marca" type="text" placeholder="Marca" />
        <input id="modelo" type="text" placeholder="Modelo" />
      </div>
      <div class="form-row">
        <input id="nro_serie" type="text" placeholder="N√∫mero de Serie" />
        <select id="estado">
          <option value="operativo">Operativo</option>
          <option value="mantenimiento">En Mantenimiento</option>
          <option value="reparacion">En Reparaci√≥n</option>
          <option value="baja">De Baja</option>
        </select>
        <button class="btn" onclick="registrarEquipo()">Registrar</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>C√≥digo QR</th>
          <th>Nombre</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Serie</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="tablaEquipos">
        <tr><td colspan="6" style="text-align:center;padding:20px">Cargando equipos...</td></tr>
      </tbody>
    </table>
  </main>

<script>
// 1. Verificar autenticaci√≥n (solo revisa localStorage)
if (!auth.requireAuth()) {
  // Si no est√° autenticado, requireAuth() ya redirige
}

// 2. Mostrar informaci√≥n del usuario
const user = auth.getUser();
if (user) {
  const nombreCompleto = `${user.nombre || ''} ${user.apellido || ''}`.trim();
  document.getElementById('sidebarName').textContent = nombreCompleto || user.email || 'Usuario';
  document.getElementById('sidebarRole').textContent = user.rol || 'Sin rol';
}

// 3. Cargar equipos
async function cargarEquipos() {
  try {
    const response = await fetch('/api/equipos/', {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('Error al cargar equipos');
    }
    
    const data = await response.json();
    const tabla = document.getElementById('tablaEquipos');
    
    if (data.equipos && data.equipos.length > 0) {
      tabla.innerHTML = data.equipos.map(e => `
        <tr>
          <td>${e.codigo_qr || 'N/A'}</td>
          <td>${e.nombre || 'N/A'}</td>
          <td>${e.marca || 'N/A'}</td>
          <td>${e.modelo || 'N/A'}</td>
          <td>${e.nro_serie || 'N/A'}</td>
          <td>${e.estado || 'N/A'}</td>
        </tr>
      `).join('');
    } else {
      tabla.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px">No hay equipos registrados</td></tr>';
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('tablaEquipos').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:red">Error al cargar equipos</td></tr>';
  }
}

// 4. Registrar equipo (ejemplo b√°sico)
async function registrarEquipo() {
  const nombre = document.getElementById('nombre').value.trim();
  const marca = document.getElementById('marca').value.trim();
  const modelo = document.getElementById('modelo').value.trim();
  const nro_serie = document.getElementById('nro_serie').value.trim();
  const estado = document.getElementById('estado').value;

  if (!nombre || !marca || !modelo) {
    alert('Complete al menos nombre, marca y modelo');
    return;
  }

  try {
    const response = await fetch('/api/equipos/', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ nombre, marca, modelo, nro_serie, estado })
    });

    if (response.ok) {
      alert('Equipo registrado correctamente');
      document.getElementById('nombre').value = '';
      document.getElementById('marca').value = '';
      document.getElementById('modelo').value = '';
      document.getElementById('nro_serie').value = '';
      cargarEquipos();
    } else {
      alert('Error al registrar equipo');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error de conexi√≥n');
  }
}

// 5. Cargar equipos al iniciar
cargarEquipos();
</script>
</body>
</html>
