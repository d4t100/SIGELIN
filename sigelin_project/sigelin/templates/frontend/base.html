<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIGELIN</title>
  <style>
    :root{--brand:#D32F2F;--bg:#f5f7fb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Roboto,Arial;background:var(--bg);color:#0b1220}
    header{height:72px;background:#fff;display:flex;align-items:center;gap:14px;padding:0 18px;border-bottom:1px solid #eef2f6}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:46px;border-radius:8px;object-fit:cover}
    .brand h3{margin:0;color:var(--brand);font-size:18px}
    .container{display:flex;min-height:calc(100vh - 72px)}
    nav{width:220px;background:#fff;border-right:1px solid #eef2f6;padding:18px}
    nav .user{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    nav img{width:44px;height:44px;border-radius:8px;object-fit:cover}
    nav ul{list-style:none;padding:0;margin:6px 0}
    nav a{display:block;padding:10px 12px;color:#0b1220;text-decoration:none;border-radius:8px;margin-bottom:6px}
    nav a.active{background:linear-gradient(90deg,var(--brand),#b71c1c);color:#fff}
    main{flex:1;padding:22px}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 20px rgba(9,30,66,0.04)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .btn{padding:10px 12px;border-radius:8px;border:none;background:var(--brand);color:#fff;cursor:pointer}
    footer{padding:18px;text-align:center;color:var(--muted);font-size:13px;background:#f8fafc}
    @media(max-width:900px){nav{display:none}}
  </style>
</head>
<script>
// Verificaci√≥n simple de autenticaci√≥n
if (!localStorage.getItem('sigelin_authenticated')) {
    window.location.href = '/';
}
</script>
<body>
  <header>
    <div class="brand">
      <img src="inacap.jpg" alt="Inacap logo">
      <div><h3>SIGELIN</h3><div style="font-size:12px;color:#94a3b8">Sistema de Gesti√≥n de Laboratorios</div></div>
    </div>
    <div style="margin-left:auto" id="headerUser"></div>
  </header>

  <div class="container">
    <nav aria-label="Navegaci√≥n principal">
      <div class="user">
        <img src="inacap.jpg" alt="avatar" id="navAvatar">
        <div>
          <div id="navName" style="font-weight:700"></div>
          <div id="navRole" style="font-size:12px;color:#94a3b8"></div>
        </div>
      </div>

      <ul id="mainMenu">
        <!-- Enlaces generados por JS -->
      </ul>

      <div style="margin-top:12px">
        <button class="btn" onclick="logout()">Cerrar sesi√≥n</button>
      </div>
    </nav>

    <main id="mainContent">
      <!-- CONTENT: reemplaza o usa template engine -->
      <div class="card">
        <h2>Bienvenido</h2>
        <p>Usa el men√∫ para navegar por los m√≥dulos.</p>
      </div>
    </main>
  </div>

  <footer>SIGELIN ¬∑ INACAP ¬∑ 2025</footer>

<script>
/* CONFIG */
const API_BASE = 'http://localhost:8000/api'; // <-- cambia si necesario

/* Helpers de autenticaci√≥n y fetch con JWT */
function getToken(){ return localStorage.getItem('sigelin_token'); }
function getUser(){ return JSON.parse(localStorage.getItem('sigelin_user') || 'null'); }

function logout(){
  localStorage.removeItem('sigelin_token');
  localStorage.removeItem('sigelin_refresh');
  localStorage.removeItem('sigelin_user');
  window.location.href = 'index.html';
}

/* Fetch wrapper que inyecta Authorization y maneja 401 */
async function apiFetch(path, opts = {}){
  const token = getToken();
  const headers = opts.headers || {};
  if(token) headers['Authorization'] = 'Bearer ' + token;
  headers['Content-Type'] = opts.body && typeof opts.body === 'object' ? 'application/json' : (headers['Content-Type'] || 'application/json');
  const res = await fetch(API_BASE + path, {...opts, headers, body: opts.body && typeof opts.body === 'object' ? JSON.stringify(opts.body) : opts.body});
  if(res.status === 401){
    // token inv√°lido/expirado -> forzar logout
    logout();
    throw new Error('No autorizado ‚Äî redirigiendo a login');
  }
  const contentType = res.headers.get('content-type') || '';
  if(contentType.includes('application/json')) return res.json();
  return res;
}

/* Render del men√∫ seg√∫n rol */
function renderMenu(){
  const user = getUser();
  const menuEl = document.getElementById('mainMenu');
  if(!user){ menuEl.innerHTML = '<li><a href="index.html">Iniciar sesi√≥n</a></li>'; return; }

  const ROLE = (user.role || user.rol || '').toLowerCase();
  const MENUS = {
    administrador: [
      {label:'Panel', href:'dashboard.html'},
      {label:'Equipos', href:'equipos.html'},
      {label:'Reparaciones', href:'reparaciones.html'},
      {label:'Inventario', href:'inventario.html'},
      {label:'Asignaciones', href:'asignaciones.html'},
      {label:'Reportes', href:'reportes.html'}
    ],
    tecnico: [
      {label:'Panel', href:'dashboard.html'},
      {label:'Equipos', href:'equipos.html'},
      {label:'Reparaciones', href:'reparaciones.html'}
    ],
    bodega: [
      {label:'Inventario', href:'inventario.html'},
      {label:'Reportes', href:'reportes.html'}
    ],
    coordinador: [
      {label:'Panel', href:'dashboard.html'},
      {label:'Reportes', href:'reportes.html'}
    ],
    jefe_area: [
      {label:'Equipos', href:'equipos.html'},
      {label:'Asignaciones', href:'asignaciones.html'}
    ],
    usuario: [
      {label:'Consulta QR', href:'consulta_qr.html'}
    ]
  };

  const items = MENUS[ROLE] || [];
  menuEl.innerHTML = items.map(i=>`<li><a href="${i.href}">${i.label}</a></li>`).join('');
}

/* Render user header */
function renderUser(){
  const u = getUser();
  if(!u){ document.getElementById('headerUser').innerHTML = '<a href="index.html">Iniciar sesi√≥n</a>'; return; }
  document.getElementById('navName').textContent = u.name || u.nombre || u.email || u.correo;
  document.getElementById('navRole').textContent = (u.role || u.rol || '').toString();
  document.getElementById('headerUser').innerHTML = `<span style="color:#475569">Hola, ${(u.name||u.nombre||'Usuario')}</span>`;
}

/* Auto-run */
renderUser();
renderMenu();

/* Export helpers al scope global por si otras p√°ginas los usan */
window.API_BASE = API_BASE;
window.apiFetch = apiFetch;
window.getToken = getToken;
window.getUser = getUser;
window.logout = logout;
</script>
</body>
<!-- MEN√ö LATERAL - Usar SIEMPRE con / al inicio -->
<a href="/dashboard.html">üìä Panel</a>
<a href="/equipos.html">üñ•Ô∏è Equipos</a>
<a href="/reparaciones.html">üîß Reparaciones</a>
<a href="/inventario.html">üì¶ Inventario</a>
<a href="/reportes.html">üìÑ Reportes</a>
<script src="/static/frontend/auth.js"></script>
</html>
